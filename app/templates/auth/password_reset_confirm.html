{% extends 'base_public.html' %}

{% block title %}Redefinir senha{% endblock %}

{% block content %}
<div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-xl shadow">
  <h2 class="text-2xl font-bold mb-4">Redefinir senha</h2>
  <form id="password-reset-confirm-form">
    <label for="new_password" class="block mb-2">Nova senha</label>
    <input type="password" id="new_password" name="new_password" class="border p-2 w-full mb-4 rounded" required>
    
    <label for="re_new_password" class="block mb-2">Confirme a nova senha</label>
    <input type="password" id="re_new_password" name="re_new_password" class="border p-2 w-full mb-4 rounded" required>
    
    <button type="submit" class="w-full bg-[#1980e6] text-white py-2 rounded">Confirmar nova senha</button>
  </form>
  <div id="message" class="mt-4 text-center"></div>
</div>

<script>
function getQueryParams() {
    const params = {};
    window.location.search.substring(1).split('&').forEach(pair => {
        const [key, value] = pair.split('=');
        params[key] = decodeURIComponent(value);
    });
    return params;
}

document.getElementById('password-reset-confirm-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const params = getQueryParams();
    const uid = params.uid;
    const token = params.token;
    const new_password = document.getElementById('new_password').value;
    const re_new_password = document.getElementById('re_new_password').value;

    if (new_password !== re_new_password) {
        document.getElementById('message').textContent = 'As senhas não conferem.';
        document.getElementById('message').classList.add('text-red-600');
        return;
    }

    const res = await fetch('/auth/users/reset_password_confirm/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid, token, new_password, re_new_password })
    });

    const msgEl = document.getElementById('message');
    if (res.ok) {
        msgEl.textContent = 'Senha alterada com sucesso! Você pode fazer login agora.';
        msgEl.classList.remove('text-red-600');
        msgEl.classList.add('text-green-600');
    } else {
        const data = await res.json();
        msgEl.textContent = 'Erro: ' + (data.detail || 'Não foi possível alterar a senha.');
        msgEl.classList.add('text-red-600');
    }
});
</script>
{% endblock %}
