{% extends 'base.html' %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-xl shadow">
    <h2 class="text-2xl font-bold mb-4">Login</h2>
    <form id="login-form">
        <label class="block mb-2">CPF</label>
        <input type="text" name="cpf" id="cpf" class="border p-2 w-full mb-4 rounded">

        <label class="block mb-2">Senha</label>
        <input type="password" name="password" id="password" class="border p-2 w-full mb-4 rounded">

        <button type="submit" class="w-full bg-[#1980e6] text-white py-2 rounded">Entrar</button>
    </form>
</div>

<script>
// ðŸ‘‡ Verifica se jÃ¡ tÃ¡ logado, e redireciona pro dashboard
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('authToken');
    if (token) {
        window.location.href = '/dashboard/';
    }
});
(async () => {
    const token = localStorage.getItem('authToken');
    if (!token) return;

    try {
        const res = await fetch('/auth/users/me/', {
            method: 'GET',
            headers: {
                'Authorization': 'Token ' + token,
                'Content-Type': 'application/json'
            }
        });

        if (res.ok) {
            window.location.href = '/dashboard/';
        } else {
            localStorage.removeItem('authToken');
        }
    } catch (err) {
        console.error('Erro ao verificar token:', err);
        localStorage.removeItem('authToken');
    }
})();

// ðŸ‘‡ Faz login e salva token
document.getElementById('login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const cpf = document.getElementById('cpf').value;
    const password = document.getElementById('password').value;

    const response = await fetch('/auth/token/login/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ cpf: cpf, password: password })
    });

    if (response.ok) {
        const data = await response.json();
        localStorage.setItem('authToken', data.auth_token);
        window.location.href = '/dashboard/';
    } else {
        alert('CPF ou senha invÃ¡lidos');
    }
});
</script>
{% endblock %}
