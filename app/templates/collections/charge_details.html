{% extends 'base.html' %}

{% block title %}Detalhes da Cobrança{% endblock %}

{% block content %}

<div class="min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8" style="font-family: Inter, 'Noto Sans', sans-serif;">
  <div class="max-w-md w-full space-y-6 p-6 bg-white rounded-xl shadow-lg">
    <h2 class="text-2xl font-bold text-center text-gray-900">Detalhes da Cobrança</h2>

    <div id="charge-details" class="space-y-4 text-gray-900 text-base">
      <!-- Conteúdo carregado via JS -->
    </div>

    <h3 class="text-xl font-semibold mt-6">Notificações enviadas</h3>
    <div id="notifications-list" class="space-y-2 text-gray-700 text-sm">
      <!-- Notificações carregadas via JS -->
    </div>

    <a href="/charges/" class="mt-6 block w-full text-center bg-gray-300 hover:bg-gray-400 text-black font-bold py-3 px-4 rounded-md shadow-sm text-sm">
      Voltar para Listagem
    </a>
  </div>
</div>

<script>
const token = localStorage.getItem('authToken');
const chargeId = "{{ charge_id }}";

async function fetchChargeDetails() {
    const response = await fetch(`/api/charges/${chargeId}/`, {
        headers: { 'Authorization': 'Token ' + token }
    });

    if (response.ok) {
        const charge = await response.json();
        renderChargeDetails(charge);
    } else {
        document.getElementById('charge-details').innerHTML = '<p class="text-red-500">Erro ao carregar detalhes.</p>';
    }
}

function renderChargeDetails(c) {
    const container = document.getElementById('charge-details');
    container.innerHTML = `
        <p><strong>Descrição:</strong> ${c.description}</p>
        <p><strong>Valor:</strong> R$ ${c.total_amount}</p>
        <p><strong>Status:</strong> ${c.status}</p>
        ${c.invoice_url ? `<p><a href="${c.invoice_url}" target="_blank" class="text-blue-600 underline">Ver boleto</a></p>` : ''}
        <!--
        <p><strong>Vencimento:</strong> ${c.due_date}</p>
        <p><strong>Parcelas:</strong> ${c.installment_count}</p>
        -->
        
    `;
}

async function fetchNotifications() {
    const response = await fetch(`/api/notifications/?charge_id=${chargeId}`, {
        headers: { 'Authorization': 'Token ' + token }
    });

    if (response.ok) {
        const notifications = await response.json();
        renderNotifications(notifications);
    } else {
        document.getElementById('notifications-list').innerHTML = '<p class="text-red-500">Erro ao carregar notificações.</p>';
    }
}

function renderNotifications(notifications) {
    const container = document.getElementById('notifications-list');
    if (notifications.length === 0) {
        container.innerHTML = '<p>Nenhuma notificação enviada ainda.</p>';
    } else {
        container.innerHTML = notifications.map(n => `
            <div class="border p-2 rounded-md bg-gray-50">
                <p><strong>Tipo:</strong> ${n.channel}</p>
                <p><strong>Data:</strong> ${new Date(n.sent_at).toLocaleString()}</p>
                <p><strong>Status:</strong> ${n.status}</p>
            </div>
        `).join('');
    }
}

fetchChargeDetails();
fetchNotifications();
</script>

{% endblock %}
